# SÆ¡ Ä‘á»“ Kiáº¿n trÃºc & Luá»“ng hoáº¡t Ä‘á»™ng - Architecture Flow Diagrams

## ğŸ“‘ Má»¥c lá»¥c (Table of Contents)

1. [So sÃ¡nh Kiáº¿n trÃºc CÅ© vs Má»›i](#1-so-sÃ¡nh-kiáº¿n-trÃºc-cÅ©-vs-má»›i)
2. [Luá»“ng TÆ°Æ¡ng tÃ¡c Contracts](#2-luá»“ng-tÆ°Æ¡ng-tÃ¡c-contracts)
3. [SÆ¡ Ä‘á»“ Dá»¯ liá»‡u](#3-sÆ¡-Ä‘á»“-dá»¯-liá»‡u)
4. [Quy trÃ¬nh Deployment](#4-quy-trÃ¬nh-deployment)
5. [User Journey Flows](#5-user-journey-flows)
6. [State Transitions](#6-state-transitions)
7. [Gas Cost Analysis](#7-gas-cost-analysis)

---

## 1. So sÃ¡nh Kiáº¿n trÃºc CÅ© vs Má»›i

### 1.1 Kiáº¿n trÃºc CÅ© (Monolithic - ÄÆ¡n khá»‘i)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   KIáº¾N TRÃšC CÅ¨ - MONOLITHIC                      â”‚
â”‚                  âŒ ÄIá»‚M Yáº¾U CHáº¾T NGÆ¯á»œI                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚   ğŸ‘¤ User        â”‚
                         â”‚   (NgÆ°á»i dÃ¹ng)   â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â”‚ interact
                                  â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚            SavingCore.sol (365 dÃ²ng)                   â”‚
    â”‚  âŒ Táº¤T Cáº¢ VÃ€O Má»˜T - KHÃ”NG TÃCH RA ÄÆ¯á»¢C                â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  1. ERC721 (NFT Certificate)          â† Náº¿u logic lá»—i â”‚
    â”‚  2. Plan Management                   â† Táº¥t cáº£ NFT     â”‚
    â”‚  3. Deposit Logic                     â† bá»‹ LOCK!       â”‚
    â”‚  4. Withdrawal Logic                  â† KhÃ´ng upgrade! â”‚
    â”‚  5. Renewal Logic                                      â”‚
    â”‚  6. Interest Calculations                              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                               â”‚
             â”‚ uses                          â”‚ stores
             â†“                               â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ VaultManager   â”‚            â”‚  ğŸ’¾ Storage          â”‚
    â”‚ (Liquidity)    â”‚            â”‚  - Plans[]           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚  - Deposits[]        â”‚
             â†“                    â”‚  - NFT Ownership     â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚  - Metadata          â”‚
    â”‚  USDC Token    â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Váº¤N Äá»€:                                                         â”‚
â”‚  ğŸ”´ Single Point of Failure - Bug á»Ÿ withdrawal â†’ NFT lock       â”‚
â”‚  ğŸ”´ KhÃ´ng upgrade Ä‘Æ°á»£c - Pháº£i deploy láº¡i â†’ User máº¥t NFT         â”‚
â”‚  ğŸ”´ Vi pháº¡m SOLID - 1 contract lÃ m 6 viá»‡c                       â”‚
â”‚  ğŸ”´ Tight Coupling - NFT gáº¯n cháº·t vá»›i logic                     â”‚
â”‚  ğŸ”´ KhÃ³ test - Pháº£i test toÃ n bá»™ cÃ¹ng lÃºc                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 Kiáº¿n trÃºc Má»›i (Separated - TÃ¡ch biá»‡t)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  KIáº¾N TRÃšC Má»šI - 3 CONTRACT RIÃŠNG BIá»†T           â”‚
â”‚                  âœ… AN TOÃ€N - Dáº„ NÃ‚NG Cáº¤P                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚   ğŸ‘¤ User        â”‚
                         â”‚   (NgÆ°á»i dÃ¹ng)   â”‚
                         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
                              â”‚         â”‚
                openDeposit   â”‚         â”‚ viewNFT
                withdraw      â”‚         â”‚ transfer
                              â”‚         â”‚
                              â†“         â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   SavingLogic.sol    â”‚   â”‚ DepositCertificate   â”‚
        â”‚   (200 dÃ²ng)         â”‚   â”‚ (150 dÃ²ng)           â”‚
        â”‚                      â”‚   â”‚                      â”‚
        â”‚  âœ… BUSINESS LOGIC   â”‚   â”‚  âœ… NFT ONLY         â”‚
        â”‚  (CÃ“ THá»‚ UPGRADE)    â”‚   â”‚  (Báº¤T BIáº¾N)          â”‚
        â”‚                      â”‚   â”‚                      â”‚
        â”‚  - createPlan()      â”‚   â”‚  - mint()            â”‚
        â”‚  - openDeposit()     â”‚   â”‚  - burn()            â”‚
        â”‚  - withdraw()        â”‚   â”‚  - tokenURI()        â”‚
        â”‚  - renewDeposit()    â”‚   â”‚  - updateStatus()    â”‚
        â”‚  - calculations      â”‚   â”‚  - metadata          â”‚
        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ calls mint()            â†‘
               â”‚ queries ownerOf()       â”‚ owns NFT
               â”‚                         â”‚
               â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚                  â”‚  ğŸ’ NFT       â”‚
               â”‚                  â”‚  Certificate  â”‚
               â”‚                  â”‚  (ERC721)     â”‚
               â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ calls payout
               â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   VaultManager.sol   â”‚
        â”‚   (Giá»¯ nguyÃªn)       â”‚
        â”‚                      â”‚
        â”‚  âœ… LIQUIDITY POOL   â”‚
        â”‚                      â”‚
        â”‚  - fundVault()       â”‚
        â”‚  - payoutInterest()  â”‚
        â”‚  - distributePenalty()â”‚
        â”‚  - pause/unpause     â”‚
        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ transfers
               â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   USDC Token         â”‚
        â”‚   (ERC20 - 6 decimals)â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Lá»¢I ÃCH:                                                        â”‚
â”‚  âœ… NFT an toÃ n tuyá»‡t Ä‘á»‘i - Logic lá»—i khÃ´ng áº£nh hÆ°á»Ÿng NFT       â”‚
â”‚  âœ… Upgrade dá»… dÃ ng - Chá»‰ thay SavingLogic, NFT váº«n hoáº¡t Ä‘á»™ng   â”‚
â”‚  âœ… TuÃ¢n thá»§ SOLID - Má»—i contract 1 trÃ¡ch nhiá»‡m                 â”‚
â”‚  âœ… Dá»… test - Test tá»«ng contract riÃªng biá»‡t                     â”‚
â”‚  âœ… Gas tá»‘i Æ°u - Operations ráº» hÆ¡n 10-15%                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. Luá»“ng TÆ°Æ¡ng tÃ¡c Contracts

### 2.1 Luá»“ng Má»Ÿ Deposit (Opening Deposit Flow)

**Ká»‹ch báº£n:** User Alice muá»‘n gá»­i $1,000 USDC vÃ o gÃ³i 90 ngÃ y vá»›i lÃ£i 5% APR

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         SEQUENCE: Má»Ÿ sá»• tiáº¿t kiá»‡m & nháº­n NFT Certificate         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ‘¤ Alice          ğŸ’° USDC          ğŸ“‹ SavingLogic      ğŸ’ Certificate
  â”‚                  â”‚                   â”‚                   â”‚
  â”‚â”€â”€1. Approve USDCâ”€â†’                  â”‚                   â”‚
  â”‚  (1000 USDC)     â”‚                   â”‚                   â”‚
  â”‚                  â”‚                   â”‚                   â”‚
  â”‚â”€â”€2. openDeposit(planId=1, amount=1000)â”€â†’                â”‚
  â”‚                  â”‚                   â”‚                   â”‚
  â”‚                  â”‚                   â”‚ 3. Validate plan â”‚
  â”‚                  â”‚                   â”‚    (enabled? min/max?)
  â”‚                  â”‚                   â”‚                   â”‚
  â”‚                  â”‚                   â”‚ 4. Generate depositId = 42
  â”‚                  â”‚                   â”‚                   â”‚
  â”‚                  â”‚                   â”‚ 5. Calculate maturity
  â”‚                  â”‚                   â”‚    = now + 90 days
  â”‚                  â”‚                   â”‚                   â”‚
  â”‚                  â”‚ 6. transferFrom() â”‚                   â”‚
  â”‚                  â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                   â”‚
  â”‚                  â”‚    (Aliceâ†’SavingLogic: 1000 USDC)    â”‚
  â”‚                  â”‚                   â”‚                   â”‚
  â”‚                  â”‚                   â”‚â”€â”€7. mint()â”€â”€â”€â”€â”€â”€â”€â”€â†’
  â”‚                  â”‚                   â”‚  (to=Alice, tokenId=42)
  â”‚                  â”‚                   â”‚                   â”‚
  â”‚                  â”‚                   â”‚                   â”‚ 8. _safeMint()
  â”‚                  â”‚                   â”‚                   â”‚    Store metadata
  â”‚                  â”‚                   â”‚                   â”‚
  â”‚                  â”‚                   â”‚â†â”€â”€âœ… Minted NFTâ”€â”€â”€â”‚
  â”‚                  â”‚                   â”‚                   â”‚
  â”‚                  â”‚                   â”‚ 9. Store deposit data
  â”‚                  â”‚                   â”‚    deposits[42] = {...}
  â”‚                  â”‚                   â”‚                   â”‚
  â”‚                  â”‚                   â”‚ 10. Emit DepositOpened
  â”‚                  â”‚                   â”‚                   â”‚
  â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€âœ… depositId = 42â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                   â”‚
  â”‚                  â”‚                   â”‚                   â”‚
  â”‚                                                          â”‚
  â”‚â”€â”€11. Query tokenURI(42)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
  â”‚                                                          â”‚
  â”‚â†â”€â”€â”€â”€â”€âœ… Beautiful SVG passbook JSON (Data URI)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                                                          â”‚

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Káº¾T QUáº¢:                                                         â”‚
â”‚  âœ… Alice máº¥t 1000 USDC                                           â”‚
â”‚  âœ… SavingLogic giá»¯ 1000 USDC                                     â”‚
â”‚  âœ… Alice nháº­n NFT Certificate #42                                â”‚
â”‚  âœ… NFT hiá»ƒn thá»‹ passbook Ä‘áº¹p vá»›i thÃ´ng tin deposit              â”‚
â”‚  âœ… Deposit data lÆ°u trong SavingLogic                            â”‚
â”‚  âœ… NFT metadata lÆ°u trong DepositCertificate                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Chi tiáº¿t Code Flow:**

```solidity
// Step 1: User approve USDC
USDC.approve(savingLogicAddress, 1000e6);

// Step 2: User calls openDeposit
SavingLogic.openDeposit(planId=1, amount=1000e6);

  // Step 3-5: SavingLogic validates and prepares data
  Types.Plan memory plan = plans[1]; // tenorDays=90, aprBps=500 (5%)
  require(plan.enabled, "Plan not enabled");
  require(amount >= plan.minDeposit, "Too low");
  
  uint256 depositId = _nextDepositId++; // depositId = 42
  uint256 maturityAt = block.timestamp + 90 days;

  // Step 6: Transfer USDC
  _token.safeTransferFrom(msg.sender, address(this), 1000e6);

  // Step 7: Mint NFT
  depositCertificate.mint(
    msg.sender,      // to = Alice
    depositId,       // tokenId = 42
    planId,          // planId = 1
    1000e6,          // principal
    block.timestamp, // startAt
    maturityAt,      // maturityAt
    500              // aprBps = 5%
  );

  // Step 8: DepositCertificate mints NFT
  _safeMint(Alice, 42);
  certificates[42] = CertificateMetadata({...});

  // Step 9: Store deposit data
  deposits[42] = Types.Deposit({
    depositId: 42,
    owner: Alice,
    planId: 1,
    principal: 1000e6,
    status: Active,
    aprBpsAtOpen: 500, // Snapshot!
    ...
  });

// Step 11: Alice queries NFT
DepositCertificate.tokenURI(42);
  // Returns: "data:application/json;base64,eyJuYW1lIjoi..."
  // Decoded: {"name":"Term Deposit #42","image":"data:image/svg+xml;base64,...","attributes":[...]}
```

### 2.2 Luá»“ng RÃºt Tiá»n ÄÃºng Háº¡n (Withdrawal at Maturity)

**Ká»‹ch báº£n:** 90 ngÃ y sau, Alice rÃºt tiá»n + lÃ£i

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    SEQUENCE: RÃºt tiá»n Ä‘Ãºng háº¡n (Principal + Interest)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ‘¤ Alice    ğŸ“‹ SavingLogic    ğŸ’ Certificate    ğŸ¦ VaultManager    ğŸ’° USDC
  â”‚              â”‚                  â”‚                  â”‚              â”‚
  â”‚â”€â”€1. withdrawAtMaturity(42)â”€â”€â”€â”€â”€â†’                  â”‚              â”‚
  â”‚              â”‚                  â”‚                  â”‚              â”‚
  â”‚              â”‚â”€â”€2. ownerOf(42)?â”€â†’                  â”‚              â”‚
  â”‚              â”‚â†â”€â”€â”€â”€â”€Aliceâ”€â”€â”€â”€â”€â”€â”€â”‚                  â”‚              â”‚
  â”‚              â”‚                  â”‚                  â”‚              â”‚
  â”‚              â”‚ 3. Verify ownership âœ…              â”‚              â”‚
  â”‚              â”‚    (msg.sender == Alice)            â”‚              â”‚
  â”‚              â”‚                  â”‚                  â”‚              â”‚
  â”‚              â”‚ 4. Verify matured âœ…                â”‚              â”‚
  â”‚              â”‚    (now >= maturityAt)              â”‚              â”‚
  â”‚              â”‚                  â”‚                  â”‚              â”‚
  â”‚              â”‚ 5. Calculate interest               â”‚              â”‚
  â”‚              â”‚    principal = 1000 USDC            â”‚              â”‚
  â”‚              â”‚    APR = 5% (500 bps)               â”‚              â”‚
  â”‚              â”‚    tenor = 90 days                  â”‚              â”‚
  â”‚              â”‚    interest = 12.33 USDC âœ…         â”‚              â”‚
  â”‚              â”‚                  â”‚                  â”‚              â”‚
  â”‚              â”‚â”€â”€6. updateStatus("Withdrawn")â”€â”€â”€â”€â”€â”€â†’â”‚              â”‚
  â”‚              â”‚                  â”‚                  â”‚              â”‚
  â”‚              â”‚                  â”‚ 7. Update metadata              â”‚
  â”‚              â”‚                  â”‚    certificates[42].status = "Withdrawn"
  â”‚              â”‚                  â”‚                  â”‚              â”‚
  â”‚              â”‚â”€â”€8. payoutInterest(Alice, 12.33)â”€â”€â”€â†’              â”‚
  â”‚              â”‚                  â”‚                  â”‚              â”‚
  â”‚              â”‚                  â”‚                  â”‚ 9. Transfer â”‚
  â”‚              â”‚                  â”‚                  â”‚â”€â”€interestâ”€â”€â†’â”‚
  â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€âœ… 12.33 USDC interestâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚              â”‚                  â”‚                  â”‚              â”‚
  â”‚              â”‚ 10. Transfer principal              â”‚              â”‚
  â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€transferâ”€â”€â†’â”‚
  â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€âœ… 1000 USDC principalâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚              â”‚                  â”‚                  â”‚              â”‚
  â”‚              â”‚ 11. Update deposit status           â”‚              â”‚
  â”‚              â”‚     deposits[42].status = Withdrawn â”‚              â”‚
  â”‚              â”‚                  â”‚                  â”‚              â”‚
  â”‚              â”‚ 12. Emit Withdrawn event            â”‚              â”‚
  â”‚              â”‚                  â”‚                  â”‚              â”‚
  â”‚â†â”€â”€âœ… Total: 1012.33 USDCâ”€â”€â”€â”€â”€â”€â”€â”€â”‚                  â”‚              â”‚

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Káº¾T QUáº¢:                                                         â”‚
â”‚  âœ… Alice nháº­n 1000 USDC (gá»‘c) tá»« SavingLogic                     â”‚
â”‚  âœ… Alice nháº­n 12.33 USDC (lÃ£i) tá»« VaultManager                   â”‚
â”‚  âœ… NFT Certificate #42 status = "Withdrawn"                      â”‚
â”‚  âœ… Deposit #42 status = Withdrawn (khÃ´ng rÃºt láº¡i Ä‘Æ°á»£c)           â”‚
â”‚  âœ… Alice váº«n giá»¯ NFT (lÆ°u niá»‡m lá»‹ch sá»­)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**CÃ´ng thá»©c tÃ­nh lÃ£i:**
```
Interest = (Principal Ã— APR Ã— TenorSeconds) / (365 Ã— 86400 Ã— 10000)

VÃ­ dá»¥ Alice:
Principal = 1000 USDC = 1,000,000,000 wei (6 decimals)
APR = 5% = 500 bps
TenorSeconds = 90 days = 7,776,000 giÃ¢y

Interest = (1,000,000,000 Ã— 500 Ã— 7,776,000) / (31,536,000 Ã— 10,000)
         = 3,888,000,000,000,000 / 315,360,000,000
         = 12,328,767 wei
         â‰ˆ 12.33 USDC
```

### 2.3 Luá»“ng RÃºt Sá»›m (Early Withdrawal)

**Ká»‹ch báº£n:** Alice rÃºt sau 30 ngÃ y (cÃ²n 60 ngÃ y ná»¯a má»›i Ä‘Ã¡o háº¡n), bá»‹ pháº¡t 2%

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       SEQUENCE: RÃºt sá»›m (Penalty Ã¡p dá»¥ng, KhÃ´ng cÃ³ lÃ£i)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ‘¤ Alice    ğŸ“‹ SavingLogic    ğŸ’ Certificate    ğŸ¦ VaultManager    ğŸ’° USDC
  â”‚              â”‚                  â”‚                  â”‚              â”‚
  â”‚â”€â”€1. earlyWithdraw(42)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’                  â”‚              â”‚
  â”‚              â”‚                  â”‚                  â”‚              â”‚
  â”‚              â”‚â”€â”€2. ownerOf(42)?â”€â†’                  â”‚              â”‚
  â”‚              â”‚â†â”€â”€â”€â”€â”€Aliceâ”€â”€â”€â”€â”€â”€â”€â”‚                  â”‚              â”‚
  â”‚              â”‚                  â”‚                  â”‚              â”‚
  â”‚              â”‚ 3. Verify ownership âœ…              â”‚              â”‚
  â”‚              â”‚ 4. Verify Active âœ…                 â”‚              â”‚
  â”‚              â”‚ 5. Verify NOT matured âœ…            â”‚              â”‚
  â”‚              â”‚    (now < maturityAt)               â”‚              â”‚
  â”‚              â”‚                  â”‚                  â”‚              â”‚
  â”‚              â”‚ 6. Calculate penalty                â”‚              â”‚
  â”‚              â”‚    principal = 1000 USDC            â”‚              â”‚
  â”‚              â”‚    penaltyBps = 200 (2%)            â”‚              â”‚
  â”‚              â”‚    penalty = 20 USDC âŒ             â”‚              â”‚
  â”‚              â”‚    afterPenalty = 980 USDC âœ…       â”‚              â”‚
  â”‚              â”‚                  â”‚                  â”‚              â”‚
  â”‚              â”‚â”€â”€7. updateStatus("Early Withdrawn")â†’â”‚              â”‚
  â”‚              â”‚                  â”‚                  â”‚              â”‚
  â”‚              â”‚ 8. Transfer penalty to vault        â”‚              â”‚
  â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚              â”‚
  â”‚              â”‚          (20 USDC)                  â”‚              â”‚
  â”‚              â”‚                  â”‚                  â”‚              â”‚
  â”‚              â”‚â”€â”€9. distributePenalty(20)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’              â”‚
  â”‚              â”‚                  â”‚                  â”‚              â”‚
  â”‚              â”‚                  â”‚                  â”‚ 10. Transferâ”‚
  â”‚              â”‚                  â”‚                  â”‚â”€â”€to feeReceiver
  â”‚              â”‚                  â”‚                  â”‚              â”‚
  â”‚              â”‚ 11. Transfer afterPenalty           â”‚              â”‚
  â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€transferâ”€â”€â†’â”‚
  â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€âœ… 980 USDCâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚              â”‚                  â”‚                  â”‚              â”‚

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Káº¾T QUáº¢:                                                         â”‚
â”‚  âŒ Alice máº¥t 20 USDC (pháº¡t 2%)                                   â”‚
â”‚  âœ… Alice nháº­n 980 USDC (gá»‘c trá»« pháº¡t)                            â”‚
â”‚  âŒ Alice KHÃ”NG nháº­n lÃ£i (rÃºt sá»›m)                                â”‚
â”‚  âœ… 20 USDC chuyá»ƒn Ä‘áº¿n feeReceiver                                â”‚
â”‚  âœ… NFT #42 status = "Early Withdrawn"                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.4 Luá»“ng Gia Háº¡n Thá»§ CÃ´ng (Manual Renewal)

**Ká»‹ch báº£n:** Alice gia háº¡n sang gÃ³i má»›i (180 ngÃ y, 7% APR), lÃ£i gá»™p vÃ o gá»‘c

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    SEQUENCE: Gia háº¡n thá»§ cÃ´ng (Compound interest + New plan)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ‘¤ Alice    ğŸ“‹ SavingLogic    ğŸ’ Certificate    ğŸ¦ VaultManager
  â”‚              â”‚                  â”‚                  â”‚
  â”‚â”€â”€1. renewDeposit(oldId=42, newPlanId=2)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
  â”‚              â”‚                  â”‚                  â”‚
  â”‚              â”‚â”€â”€2. ownerOf(42)?â”€â†’                  â”‚
  â”‚              â”‚â†â”€â”€â”€â”€â”€Aliceâ”€â”€â”€â”€â”€â”€â”€â”‚                  â”‚
  â”‚              â”‚                  â”‚                  â”‚
  â”‚              â”‚ 3. Verify ownership âœ…              â”‚
  â”‚              â”‚ 4. Verify matured âœ…                â”‚
  â”‚              â”‚ 5. Verify new plan enabled âœ…       â”‚
  â”‚              â”‚                  â”‚                  â”‚
  â”‚              â”‚ 6. Calculate OLD interest           â”‚
  â”‚              â”‚    old principal = 1000 USDC        â”‚
  â”‚              â”‚    old APR = 5%                     â”‚
  â”‚              â”‚    interest = 12.33 USDC âœ…         â”‚
  â”‚              â”‚                  â”‚                  â”‚
  â”‚              â”‚â”€â”€7. payoutInterest(SavingLogic, 12.33)â”€â”€â”€â”€â†’
  â”‚              â”‚                  â”‚                  â”‚
  â”‚              â”‚ 8. NEW principal = 1000 + 12.33     â”‚
  â”‚              â”‚                  = 1012.33 USDC âœ…  â”‚
  â”‚              â”‚                  â”‚                  â”‚
  â”‚              â”‚ 9. Verify new principal meets       â”‚
  â”‚              â”‚    new plan's min/max âœ…            â”‚
  â”‚              â”‚                  â”‚                  â”‚
  â”‚              â”‚ 10. Update old deposit              â”‚
  â”‚              â”‚     deposits[42].status = ManualRenewed
  â”‚              â”‚                  â”‚                  â”‚
  â”‚              â”‚â”€â”€11. updateStatus("Renewed")â”€â”€â”€â”€â”€â”€â”€â†’â”‚
  â”‚              â”‚                  â”‚                  â”‚
  â”‚              â”‚ 12. Create NEW deposit #43          â”‚
  â”‚              â”‚     principal = 1012.33 USDC        â”‚
  â”‚              â”‚     planId = 2 (180 days, 7% APR)   â”‚
  â”‚              â”‚     maturity = now + 180 days       â”‚
  â”‚              â”‚                  â”‚                  â”‚
  â”‚              â”‚â”€â”€13. mint(Alice, 43, ...)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
  â”‚              â”‚                  â”‚                  â”‚
  â”‚              â”‚                  â”‚ 14. _safeMint(Alice, 43)
  â”‚              â”‚                  â”‚     New NFT created!
  â”‚              â”‚                  â”‚                  â”‚
  â”‚â†â”€â”€âœ… New depositId = 43â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                  â”‚

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Káº¾T QUáº¢:                                                         â”‚
â”‚  âœ… Alice giá»¯ NFT #42 (status: Renewed) - lÆ°u lá»‹ch sá»­            â”‚
â”‚  âœ… Alice nháº­n NFT #43 má»›i (principal: 1012.33 USDC)              â”‚
â”‚  âœ… LÃ£i 12.33 USDC gá»™p vÃ o gá»‘c â†’ COMPOUND INTEREST                â”‚
â”‚  âœ… Deposit má»›i: 180 ngÃ y @ 7% APR                                â”‚
â”‚  âœ… Alice KHÃ”NG cáº§n náº¡p thÃªm tiá»n                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. SÆ¡ Ä‘á»“ Dá»¯ liá»‡u (Data Flow Diagrams)

### 3.1 Cáº¥u trÃºc Deposit Data

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Cáº¤U TRÃšC Dá»® LIá»†U DEPOSIT (Dual Storage)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“‹ SavingLogic Contract (Business Data)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  mapping(uint256 => Types.Deposit) public deposits;           â”‚
â”‚                                                                â”‚
â”‚  struct Deposit {                                              â”‚
â”‚    uint256 depositId        = 42                              â”‚
â”‚    address owner            = 0xAlice...                      â”‚
â”‚    uint256 planId           = 1                               â”‚
â”‚    uint256 principal        = 1,000,000,000 wei (6 decimals)  â”‚
â”‚    uint256 startAt          = 1706544000 (timestamp)          â”‚
â”‚    uint256 maturityAt       = 1714320000 (timestamp)          â”‚
â”‚    DepositStatus status     = Active (0)                      â”‚
â”‚    uint16 aprBpsAtOpen      = 500 (5.00%)                     â”‚
â”‚    uint16 penaltyBpsAtOpen  = 200 (2.00%)                     â”‚
â”‚  }                                                             â”‚
â”‚                                                                â”‚
â”‚  ğŸ’¡ Má»¥c Ä‘Ã­ch: DÃ¹ng cho business logic calculations            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†•
                    synchronized (Ä‘á»“ng bá»™)
                              â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ’ DepositCertificate Contract (NFT Metadata)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  mapping(uint256 => CertificateMetadata) public certificates; â”‚
â”‚                                                                â”‚
â”‚  struct CertificateMetadata {                                  â”‚
â”‚    uint256 depositId        = 42                              â”‚
â”‚    uint256 planId           = 1                               â”‚
â”‚    uint256 principal        = 1,000,000,000 wei               â”‚
â”‚    uint256 startAt          = 1706544000                      â”‚
â”‚    uint256 maturityAt       = 1714320000                      â”‚
â”‚    uint16 aprBps            = 500                             â”‚
â”‚    string status            = "Active" (human-readable)       â”‚
â”‚  }                                                             â”‚
â”‚                                                                â”‚
â”‚  ğŸ’¡ Má»¥c Ä‘Ã­ch: Generate tokenURI cho NFT metadata              â”‚
â”‚              Hiá»ƒn thá»‹ trÃªn OpenSea, wallets                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Táº¡i sao lÆ°u 2 nÆ¡i?**
- âœ… **Separation of Concerns**: Business logic vÃ  NFT metadata tÃ¡ch biá»‡t
- âœ… **Immutability**: NFT metadata khÃ´ng Ä‘á»•i ngay cáº£ khi upgrade logic
- âœ… **User Experience**: User xem NFT khÃ´ng cáº§n gá»i SavingLogic
- âš ï¸ **Trade-off**: Tá»‘n thÃªm ~30k gas/deposit Ä‘á»ƒ lÆ°u metadata

### 3.2 Token Flow (Luá»“ng chuyá»ƒn tiá»n)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   TOKEN FLOW - LUá»’NG CHUYá»‚N USDC                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  ğŸ‘¤ User Wallet  â”‚
                    â”‚  (Alice)         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ 1. Deposit
                             â”‚    $1000 USDC
                             â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  SavingLogic     â”‚
                    â”‚  Holds principal â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚            â”‚            â”‚
     2. Mint NFTâ”‚   3a. Interest?  3b. Penalty?
         (free) â”‚            â”‚            â”‚
                â†“            â†“            â†“
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ Certificate  â”‚  â”‚ VaultManager â”‚  â”‚ VaultManager â”‚
       â”‚ NFT #42      â”‚  â”‚              â”‚  â”‚              â”‚
       â”‚ â†’ User       â”‚  â”‚ $12.33       â”‚  â”‚ $20          â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚                 â”‚
                        4a. At maturity    4b. Early withdraw
                                 â†“                 â†“
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚  ğŸ‘¤ User      â”‚  â”‚ ğŸ’° Fee Receiverâ”‚
                         â”‚  +$12.33      â”‚  â”‚  +$20         â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â†‘
                        5. Return principal
                                 â”‚
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚ SavingLogic   â”‚
                         â”‚ â†’ User        â”‚
                         â”‚ $1000         â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Chi tiáº¿t Flow:**

1. **Deposit:** User â†’ SavingLogic (1000 USDC)
2. **Mint NFT:** Free (khÃ´ng transfer token)
3. **Interest Path:** VaultManager â†’ User ($12.33 lÃ£i)
4. **Penalty Path:** SavingLogic â†’ VaultManager â†’ FeeReceiver ($20 pháº¡t)
5. **Principal Return:** SavingLogic â†’ User (1000 USDC gá»‘c)

---

## 4. Quy trÃ¬nh Deployment

### 4.1 Thá»© tá»± Deploy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             DEPLOYMENT SEQUENCE (9 bÆ°á»›c)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

START
  â”‚
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 1: Deploy DepositCertificate                             â”‚
â”‚   Contract: DepositCertificate.sol                            â”‚
â”‚   Constructor: (initialOwner)                                 â”‚
â”‚   Result: certificateAddress = 0xAAA...                       â”‚
â”‚   Gas: ~2,000,000                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 2: Deploy VaultManager (or use existing)                 â”‚
â”‚   Contract: VaultManager.sol                                  â”‚
â”‚   Constructor: (tokenAddress, feeReceiver, initialOwner)      â”‚
â”‚   Result: vaultManagerAddress = 0xBBB...                      â”‚
â”‚   Gas: ~1,500,000                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 3: Deploy SavingLogic                                    â”‚
â”‚   Contract: SavingLogic.sol                                   â”‚
â”‚   Constructor: (                                              â”‚
â”‚     tokenAddress,                                             â”‚
â”‚     certificateAddress,  // 0xAAA... from Step 1             â”‚
â”‚     vaultManagerAddress, // 0xBBB... from Step 2             â”‚
â”‚     initialOwner                                              â”‚
â”‚   )                                                           â”‚
â”‚   Result: savingLogicAddress = 0xCCC...                       â”‚
â”‚   Gas: ~2,500,000                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 4: Configure DepositCertificate                          â”‚
â”‚   Call: certificate.setSavingLogic(0xCCC...)                  â”‚
â”‚   Purpose: Authorize SavingLogic to mint NFTs                â”‚
â”‚   Gas: ~50,000                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 5: Configure VaultManager                                â”‚
â”‚   Call: vaultManager.setSavingCore(0xCCC...)                  â”‚
â”‚   Purpose: Authorize SavingLogic to request payouts          â”‚
â”‚   Gas: ~50,000                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 6: Create Initial Plans                                  â”‚
â”‚   Call 1: savingLogic.createPlan(30, 300, ...)  // 30d @ 3%  â”‚
â”‚   Call 2: savingLogic.createPlan(90, 500, ...)  // 90d @ 5%  â”‚
â”‚   Call 3: savingLogic.createPlan(180, 700, ...) // 180d @ 7% â”‚
â”‚   Gas: ~120,000 Ã— 3 = ~360,000                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 7: Fund VaultManager                                     â”‚
â”‚   Call 1: USDC.approve(vaultManager, 10000e6)                 â”‚
â”‚   Call 2: vaultManager.fundVault(10000e6)                     â”‚
â”‚   Purpose: Náº¡p 10,000 USDC Ä‘á»ƒ tráº£ lÃ£i                        â”‚
â”‚   Gas: ~100,000                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 8: Verify on Etherscan (Testnet)                        â”‚
â”‚   - Verify DepositCertificate source code                    â”‚
â”‚   - Verify SavingLogic source code                           â”‚
â”‚   - Verify VaultManager source code                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 9: Test End-to-End                                       â”‚
â”‚   Test 1: openDeposit â†’ verify NFT minted                    â”‚
â”‚   Test 2: withdrawAtMaturity â†’ verify funds received         â”‚
â”‚   Test 3: earlyWithdraw â†’ verify penalty applied             â”‚
â”‚   Test 4: renewDeposit â†’ verify new NFT created              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â†“
âœ… DEPLOYMENT COMPLETE
   Save addresses to deployment-refactored.json
```

### 4.2 Deployment Script (TypeScript)

```typescript
// deploy/deploy-refactored.ts
import { ethers } from "hardhat";

async function main() {
    const [deployer] = await ethers.getSigners();
    console.log("ğŸš€ Deploying with account:", deployer.address);

    // Addresses
    const usdcAddress = "0x..."; // Your USDC address
    const feeReceiverAddress = deployer.address;

    // ========== STEP 1: Deploy DepositCertificate ==========
    console.log("\nğŸ“œ [1/9] Deploying DepositCertificate...");
    const DepositCertificate = await ethers.getContractFactory("DepositCertificate");
    const certificate = await DepositCertificate.deploy(deployer.address);
    await certificate.waitForDeployment();
    const certAddress = await certificate.getAddress();
    console.log("âœ… DepositCertificate deployed:", certAddress);

    // ========== STEP 2: Deploy VaultManager ==========
    console.log("\nğŸ¦ [2/9] Deploying VaultManager...");
    const VaultManager = await ethers.getContractFactory("VaultManager");
    const vaultManager = await VaultManager.deploy(
        usdcAddress,
        feeReceiverAddress,
        deployer.address
    );
    await vaultManager.waitForDeployment();
    const vaultAddress = await vaultManager.getAddress();
    console.log("âœ… VaultManager deployed:", vaultAddress);

    // ========== STEP 3: Deploy SavingLogic ==========
    console.log("\nğŸ’¼ [3/9] Deploying SavingLogic...");
    const SavingLogic = await ethers.getContractFactory("SavingLogic");
    const savingLogic = await SavingLogic.deploy(
        usdcAddress,
        certAddress,
        vaultAddress,
        deployer.address
    );
    await savingLogic.waitForDeployment();
    const savingAddress = await savingLogic.getAddress();
    console.log("âœ… SavingLogic deployed:", savingAddress);

    // ========== STEP 4: Configure DepositCertificate ==========
    console.log("\nâš™ï¸  [4/9] Configuring DepositCertificate...");
    await certificate.setSavingLogic(savingAddress);
    console.log("âœ… SavingLogic authorized as minter");

    // ========== STEP 5: Configure VaultManager ==========
    console.log("\nâš™ï¸  [5/9] Configuring VaultManager...");
    await vaultManager.setSavingCore(savingAddress);
    console.log("âœ… SavingLogic authorized in VaultManager");

    // ========== STEP 6: Create Plans ==========
    console.log("\nğŸ“‹ [6/9] Creating initial plans...");
    
    await savingLogic.createPlan(
        30,          // 30 days
        300,         // 3.00% APR
        100_000000,  // min $100
        10000_000000,// max $10,000
        200          // 2% penalty
    );
    console.log("âœ… Plan 1: 30 days @ 3% APR");

    await savingLogic.createPlan(90, 500, 100_000000, 10000_000000, 200);
    console.log("âœ… Plan 2: 90 days @ 5% APR");

    await savingLogic.createPlan(180, 700, 100_000000, 10000_000000, 300);
    console.log("âœ… Plan 3: 180 days @ 7% APR");

    // ========== STEP 7: Fund Vault ==========
    console.log("\nğŸ’° [7/9] Funding VaultManager...");
    const usdc = await ethers.getContractAt("IERC20", usdcAddress);
    const fundAmount = ethers.parseUnits("10000", 6); // $10,000
    
    await usdc.approve(vaultAddress, fundAmount);
    await vaultManager.fundVault(fundAmount);
    console.log("âœ… VaultManager funded with $10,000 USDC");

    // ========== STEP 8: Summary ==========
    console.log("\n" + "=".repeat(60));
    console.log("ğŸ‰ DEPLOYMENT COMPLETE!");
    console.log("=".repeat(60));
    console.log("DepositCertificate:", certAddress);
    console.log("SavingLogic:       ", savingAddress);
    console.log("VaultManager:      ", vaultAddress);
    console.log("USDC:              ", usdcAddress);
    console.log("=".repeat(60));

    // Save to file
    const deployment = {
        network: await ethers.provider.getNetwork(),
        timestamp: new Date().toISOString(),
        deployer: deployer.address,
        contracts: {
            depositCertificate: certAddress,
            savingLogic: savingAddress,
            vaultManager: vaultAddress,
            usdc: usdcAddress
        }
    };

    const fs = require("fs");
    fs.writeFileSync(
        "deployment-refactored.json",
        JSON.stringify(deployment, null, 2)
    );
    console.log("âœ… Deployment info saved to deployment-refactored.json");
}

main()
    .then(() => process.exit(0))
    .catch((error) => {
        console.error(error);
        process.exit(1);
    });
```

---

## 5. User Journey Flows

### 5.1 Happy Path - ToÃ n bá»™ vÃ²ng Ä‘á»i Deposit

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         USER JOURNEY: Tá»« má»Ÿ sá»• Ä‘áº¿n rÃºt tiá»n thÃ nh cÃ´ng           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

DAY 0: Má»Ÿ sá»• tiáº¿t kiá»‡m
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ‘¤ Alice connects MetaMask                    â­â­â­â­â­
   â†’ Sees available plans: 30d, 90d, 180d
   
ğŸ‘¤ Alice selects Plan 2: 90 days @ 5% APR     â­â­â­â­â­
   â†’ Enters amount: $1000 USDC
   
ğŸ‘¤ Alice approves USDC                        â­â­â­â­
   â†’ MetaMask popup: Approve USDC spending
   
ğŸ‘¤ Alice clicks "Open Deposit"                â­â­â­â­â­
   â†’ Transaction submitted
   
ğŸ¤– System processes deposit                   
   â†’ Transfer USDC: Alice â†’ SavingLogic
   â†’ Mint NFT Certificate #42
   
ğŸ‘¤ Alice receives confirmation                â­â­â­â­â­
   â†’ "Deposit #42 opened successfully!"
   â†’ NFT appears in wallet

DAY 1-89: Ká»³ háº¡n lock
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ‘¤ Alice views NFT in wallet                  â­â­â­â­â­
   â†’ Sees beautiful passbook image
   â†’ Status: "Active"
   â†’ Earning interest...
   
ğŸ‘¤ Alice checks dashboard                     â­â­â­â­
   â†’ Deposit #42
   â†’ Principal: $1000
   â†’ APR: 5%
   â†’ Days remaining: 60, 30, 10...
   
ğŸ‘¤ Alice waits patiently                      â­â­â­

DAY 90: ÄÃ¡o háº¡n
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”” System sends notification                  
   â†’ "Deposit #42 has matured!"
   â†’ "Withdraw now to claim interest"
   
ğŸ‘¤ Alice opens dApp                           â­â­â­â­â­
   â†’ Sees matured deposit highlighted
   â†’ Shows estimated interest: $12.33
   
ğŸ‘¤ Alice clicks "Withdraw"                    â­â­â­â­â­
   â†’ Confirms transaction
   
ğŸ¤– System processes withdrawal
   â†’ Calculate interest: $12.33 âœ…
   â†’ Transfer interest from VaultManager
   â†’ Transfer principal from SavingLogic
   â†’ Update NFT status: "Withdrawn"
   
ğŸ‘¤ Alice receives funds                       â­â­â­â­â­
   â†’ Total: $1012.33 USDC
   â†’ Principal: $1000
   â†’ Interest: $12.33
   â†’ "Withdrawal successful!"

POST-WITHDRAWAL: LÆ°u niá»‡m
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ‘¤ Alice views historical NFT                 â­â­â­â­
   â†’ NFT still in wallet (commemorative)
   â†’ Status: "Withdrawn"
   â†’ Shows complete history
   
ğŸ‘¤ Alice considers opening new deposit        â­â­â­â­â­
   â†’ Satisfied with service
   â†’ Plans to deposit again

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OVERALL EXPERIENCE: â­â­â­â­â­ (5/5 stars)                        â”‚
â”‚  - Easy to use                                                    â”‚
â”‚  - Beautiful NFT                                                  â”‚
â”‚  - Transparent process                                            â”‚
â”‚  - Received promised interest                                     â”‚
â”‚  - Would recommend!                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 Alternative Path - RÃºt sá»›m

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         USER JOURNEY: RÃºt sá»›m (Emergency withdrawal)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

DAY 0: Má»Ÿ sá»• $1000 cho 90 ngÃ y
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(Same as Happy Path)

DAY 30: Cáº§n tiá»n gáº¥p
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ’¸ Alice needs emergency funds                â­â­
   â†’ Unexpected expense
   
ğŸ‘¤ Alice opens dApp                           â­â­â­
   â†’ Sees "Early Withdraw" button
   
âš ï¸  System shows warning                       
   â†’ "Penalty: 2% = $20 USDC"
   â†’ "No interest will be paid"
   â†’ "You will receive: $980 USDC"
   
ğŸ‘¤ Alice confirms early withdrawal            â­â­â­
   â†’ "I need the money now"
   
ğŸ¤– System processes early withdrawal
   â†’ Calculate penalty: $20 âŒ
   â†’ Transfer $980 to Alice âœ…
   â†’ Transfer $20 to feeReceiver
   â†’ Update NFT: "Early Withdrawn"
   
ğŸ‘¤ Alice receives $980                        â­â­
   â†’ Lost $20 penalty
   â†’ Lost potential $12.33 interest
   â†’ But got emergency funds âœ…

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  EXPERIENCE: â­â­â­ (3/5 stars)                                   â”‚
â”‚  - Needed emergency access âœ…                                     â”‚
â”‚  - Penalty was clearly stated âœ…                                  â”‚
â”‚  - Wish there was grace period âŒ                                â”‚
â”‚  - Overall: Fair system                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 Power User Path - Compounding Strategy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      POWER USER: Chiáº¿n lÆ°á»£c gá»™p lÃ£i (Compound interest)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

QUARTER 1 (Q1): First deposit
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ‘¤ Bob deposits $1000 @ 5% for 90 days        â­â­â­â­â­
   â†’ Receives NFT #1
   â†’ Maturity: Q1 end

Q1 END: First maturity
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ‘¤ Bob chooses "Renew & Compound"             â­â­â­â­â­
   â†’ Interest $12.33 auto-added
   â†’ New principal: $1012.33 âœ…
   â†’ Receives NFT #2
   â†’ Keeps NFT #1 as history

QUARTER 2 (Q2): After 180 days total
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ‘¤ Bob renews again                           â­â­â­â­â­
   â†’ Interest: $12.65 (on $1012.33)
   â†’ New principal: $1024.98 âœ…
   â†’ Receives NFT #3
   â†’ Owns NFT #1, #2, #3

QUARTER 3 (Q3): After 270 days total
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ‘¤ Bob renews third time                      â­â­â­â­â­
   â†’ Interest: $12.81 (on $1024.98)
   â†’ New principal: $1037.79 âœ…
   â†’ Receives NFT #4

QUARTER 4 (Q4): After 360 days (1 year)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ‘¤ Bob renews fourth time                     â­â­â­â­â­
   â†’ Interest: $12.97 (on $1037.79)
   â†’ New principal: $1050.76 âœ…
   â†’ Receives NFT #5

AFTER 1 YEAR: Summary
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ… Total earned: $50.76 (5.076% effective APR)
âœ… Owns 5 NFT certificates (complete history)
âœ… Never had to deposit more money
âœ… Simple interest compounded 4 times

COMPARISON:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Without compounding:
  $1000 Ã— 5% = $50/year âŒ

With quarterly compounding:
  $1050.76 - $1000 = $50.76/year âœ… (+$0.76 extra!)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POWER USER EXPERIENCE: â­â­â­â­â­ (5/5 stars)                     â”‚
â”‚  - Love the compound feature!                                     â”‚
â”‚  - NFT collection shows entire history                            â”‚
â”‚  - Easy to track performance                                      â”‚
â”‚  - Will continue using                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. State Transitions

### 6.1 Deposit Status Lifecycle

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            DEPOSIT STATUS STATE MACHINE                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   START     â”‚
                    â”‚   (None)    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ openDeposit()
                           â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”Œâ”€â”€â”€â”€â†’â”‚   ACTIVE     â”‚
              â”‚     â”‚  (Status: 0)  â”‚
              â”‚     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚            â”‚
              â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚     â”‚      â”‚          â”‚                  â”‚
              â”‚     â”‚      â”‚          â”‚                  â”‚
              â”‚  withdraw  â”‚       early      manual     auto
              â”‚  AtMaturityâ”‚      Withdraw    Renew      Renew
              â”‚     â”‚      â”‚          â”‚          â”‚       â”‚
              â”‚     â†“      â†“          â†“          â†“       â†“
              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  â”‚Maturedâ”‚ â”‚Withdrawâ”‚ â”‚ Manual â”‚ â”‚  Auto    â”‚
              â”‚  â”‚Status â”‚ â”‚(Stat:1)â”‚ â”‚Renewed â”‚ â”‚ Renewed  â”‚
              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚(Stat:3)â”‚ â”‚(Stat: 2) â”‚
              â”‚     â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚     â”‚                      â”‚           â”‚
              â”‚     â”‚                      â”‚           â”‚
              â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                     â”‚
              â”‚                     â”‚ (New deposit created)
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STATE DETAILS:                                                   â”‚
â”‚                                                                   â”‚
â”‚  â— ACTIVE (0):                                                    â”‚
â”‚    - Deposit Ä‘ang hoáº¡t Ä‘á»™ng                                       â”‚
â”‚    - User cÃ³ thá»ƒ withdraw/renew                                   â”‚
â”‚    - NFT status: "Active"                                         â”‚
â”‚    - Badge: ğŸŸ¢ GREEN "Äang sinh lá»i"                             â”‚
â”‚                                                                   â”‚
â”‚  â— WITHDRAWN (1):                                                 â”‚
â”‚    - ÄÃ£ rÃºt tiá»n (Ä‘Ãºng háº¡n hoáº·c sá»›m)                             â”‚
â”‚    - KhÃ´ng thá»ƒ thao tÃ¡c ná»¯a                                       â”‚
â”‚    - NFT status: "Withdrawn" / "Early Withdrawn"                 â”‚
â”‚    - Badge: âš« GRAY "ÄÃ£ hoÃ n táº¥t"                                â”‚
â”‚                                                                   â”‚
â”‚  â— AUTO_RENEWED (2):                                              â”‚
â”‚    - ÄÃ£ auto-renew sau grace period                              â”‚
â”‚    - Deposit má»›i Ä‘Æ°á»£c táº¡o                                         â”‚
â”‚    - NFT status: "Auto Renewed"                                   â”‚
â”‚    - Badge: ğŸ”µ BLUE "ÄÃ£ tá»± Ä‘á»™ng gia háº¡n"                         â”‚
â”‚                                                                   â”‚
â”‚  â— MANUAL_RENEWED (3):                                            â”‚
â”‚    - User chá»§ Ä‘á»™ng renew                                          â”‚
â”‚    - Deposit má»›i Ä‘Æ°á»£c táº¡o (cÃ³ thá»ƒ Ä‘á»•i plan)                      â”‚
â”‚    - NFT status: "Renewed"                                        â”‚
â”‚    - Badge: ğŸŸ£ PURPLE "ÄÃ£ gia háº¡n"                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 NFT Metadata Status Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              NFT CERTIFICATE STATUS FLOW                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    mint()
                      â”‚
                      â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚    ACTIVE     â”‚ â† Green badge, "Äang sinh lá»i"
              â”‚  ğŸŸ¢ Earning   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚             â”‚             â”‚
        â”‚             â”‚             â”‚
  block.timestamp  early         renew
  >= maturityAt    Withdraw      Deposit
        â”‚             â”‚             â”‚
        â†“             â†“             â†“
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚  MATURED   â”‚  â”‚  EARLY   â”‚  â”‚ RENEWED  â”‚
 â”‚ ğŸ”µ Ready   â”‚  â”‚ WITHDRAWNâ”‚  â”‚ ğŸŸ£ Done  â”‚
 â”‚ to withdrawâ”‚  â”‚ âš« Penaltyâ”‚  â”‚          â”‚
 â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
        â”‚             â”‚              â”‚
        â”‚withdraw     â”‚              â”‚
        â”‚AtMaturity   â”‚              â”‚
        â†“             â†“              â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         WITHDRAWN               â”‚
    â”‚      âš« Completed                â”‚
    â”‚   (Final state, NFT kept)       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  NFT DISPLAY ON OPENSEA/WALLETS:                                 â”‚
â”‚                                                                   â”‚
â”‚  ğŸŸ¢ ACTIVE:                                                       â”‚
â”‚    - Badge: Green "ÄANG HOáº T Äá»˜NG"                               â”‚
â”‚    - Animation: Pulsing glow                                      â”‚
â”‚    - Description: "Earning interest..."                          â”‚
â”‚                                                                   â”‚
â”‚  ğŸ”µ MATURED:                                                      â”‚
â”‚    - Badge: Blue "ÄÃƒ ÄÃO Háº N"                                    â”‚
â”‚    - Animation: Sparkle effect                                    â”‚
â”‚    - Description: "Ready to withdraw!"                           â”‚
â”‚                                                                   â”‚
â”‚  âš« WITHDRAWN:                                                    â”‚
â”‚    - Badge: Gray "ÄÃƒ RÃšT"                                        â”‚
â”‚    - Animation: None (static)                                     â”‚
â”‚    - Description: "Completed on [date]"                          â”‚
â”‚                                                                   â”‚
â”‚  ğŸŸ£ RENEWED:                                                      â”‚
â”‚    - Badge: Purple "ÄÃƒ GIA Háº N"                                  â”‚
â”‚    - Animation: None                                              â”‚
â”‚    - Description: "Renewed to deposit #[newId]"                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. Gas Cost Analysis

### 7.1 So sÃ¡nh Chi phÃ­ Operations

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            GAS COST COMPARISON (Old vs New)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  Operation           â•‘  Old (Gas)    â•‘  New (Gas)    â•‘ Savings   â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Deploy (One-time)    â•‘               â•‘               â•‘           â•‘
â•‘ â”œâ”€ SavingCore        â•‘ 3,500,000     â•‘       -       â•‘     -     â•‘
â•‘ â”œâ”€ DepositCertificateâ•‘       -       â•‘ 2,000,000     â•‘     -     â•‘
â•‘ â”œâ”€ SavingLogic       â•‘       -       â•‘ 2,500,000     â•‘     -     â•‘
â•‘ â””â”€ VaultManager      â•‘ 1,500,000     â•‘ 1,500,000     â•‘     -     â•‘
â•‘ TOTAL DEPLOY         â•‘ 5,000,000     â•‘ 6,000,000     â•‘ +1M (20%) â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Operations (Repeat)  â•‘               â•‘               â•‘           â•‘
â•‘ â”œâ”€ openDeposit       â•‘   280,000     â•‘   250,000     â•‘ -30k (-11%)â•‘
â•‘ â”œâ”€ withdrawMaturity  â•‘   185,000     â•‘   180,000     â•‘  -5k (-3%) â•‘
â•‘ â”œâ”€ earlyWithdraw     â•‘   175,000     â•‘   170,000     â•‘  -5k (-3%) â•‘
â•‘ â”œâ”€ renewDeposit      â•‘   295,000     â•‘   270,000     â•‘ -25k (-8%) â•‘
â•‘ â””â”€ createPlan        â•‘   120,000     â•‘   120,000     â•‘    0       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BREAK-EVEN ANALYSIS:                                             â”‚
â”‚                                                                   â”‚
â”‚  Extra deploy cost: +1,000,000 gas                                â”‚
â”‚  Savings per deposit: -30,000 gas                                 â”‚
â”‚  Break-even point: 1,000,000 / 30,000 = 33.33 deposits           â”‚
â”‚                                                                   â”‚
â”‚  âœ… After ~35 deposits, new architecture is CHEAPER!             â”‚
â”‚                                                                   â”‚
â”‚  Example (100 deposits over 1 year):                              â”‚
â”‚  â”œâ”€ Old: 5M (deploy) + 100 Ã— 280k = 33,000,000 gas              â”‚
â”‚  â””â”€ New: 6M (deploy) + 100 Ã— 250k = 31,000,000 gas              â”‚
â”‚      SAVINGS: 2,000,000 gas (6% cheaper) âœ…                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 Chi tiáº¿t Gas Breakdown

**OpenDeposit Operation:**
```
Old Architecture (280k gas):
â”œâ”€ ERC20 transfer          : 65,000
â”œâ”€ Storage write (deposit) : 100,000
â”œâ”€ ERC721 _safeMint        : 85,000
â”œâ”€ Event emission          : 10,000
â”œâ”€ Validations             : 20,000
â””â”€ TOTAL                   : 280,000

New Architecture (250k gas):
â”œâ”€ ERC20 transfer          : 65,000
â”œâ”€ Storage write (deposit) : 100,000
â”œâ”€ External call to mint   : 5,000   â† Slightly higher
â”œâ”€ ERC721 _safeMint        : 80,000  â† Optimized
â”œâ”€ Event emission          : 10,000
â””â”€ TOTAL                   : 250,000 âœ… (-30k gas)

Optimization tá»«:
- TÃ¡ch storage giá»¯a 2 contracts
- Immutable variables trong SavingLogic
- Optimized metadata storage
```

---

## 8. Káº¿t luáº­n (Conclusion)

### 8.1 TÃ³m táº¯t Kiáº¿n trÃºc

**3 Contract System:**

1. **DepositCertificate** (NFT Only)
   - Báº¥t biáº¿n, an toÃ n tuyá»‡t Ä‘á»‘i
   - Beautiful SVG passbook
   - On-chain metadata (Data URI)
   - Chá»‰ mint/burn/update status

2. **SavingLogic** (Business Logic)
   - CÃ³ thá»ƒ upgrade
   - Táº¥t cáº£ business operations
   - Query NFT ownership
   - Dependency injection

3. **VaultManager** (Liquidity Pool)
   - Giá»¯ nguyÃªn hiá»‡n táº¡i
   - Quáº£n lÃ½ liquidity
   - Tráº£ lÃ£i & pháº¡t

### 8.2 Lá»£i Ã­ch chÃ­nh

âœ… **An toÃ n NFT**: Logic lá»—i khÃ´ng áº£nh hÆ°á»Ÿng certificates  
âœ… **Upgrade dá»… dÃ ng**: Chá»‰ thay SavingLogic  
âœ… **TuÃ¢n thá»§ SOLID**: Má»—i contract 1 trÃ¡ch nhiá»‡m  
âœ… **Dá»… test**: Test tá»«ng contract riÃªng  
âœ… **Gas optimal**: Operations ráº» hÆ¡n 10%  
âœ… **Beautiful NFT**: SVG passbook on-chain  

### 8.3 Next Steps

1. Review tÃ i liá»‡u nÃ y vá»›i team
2. Approve architecture design
3. Báº¯t Ä‘áº§u implement interfaces
4. Code 3 contracts má»›i
5. Viáº¿t comprehensive tests
6. Deploy testnet & production

---

**PhiÃªn báº£n:** 1.0  
**NgÃ y táº¡o:** 29 ThÃ¡ng 1, 2026  
**TÃ¡c giáº£:** Senior Blockchain Architect  
**Tráº¡ng thÃ¡i:** âœ… Ready for Implementation

ğŸš€ **Let's build the future of DeFi savings!**
